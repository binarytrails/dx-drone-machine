<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='main.css') }}">

    <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/map.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/geodata/worldLow.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.2.0/socket.io.min.js"></script>
</head>
<body>
    <div id="circle-container">
    	<div id="twr_P_bot-div" onclick="playAudio('twr_P_bot')" class="circle" style="top: 315px; left: 165px;">
        <audio id="twr_P_bot" src="{{ url_for('static', filename='audio/twr_P_bot.flac') }}"></audio>
    	</div>
    	<div id="twr_P_mid-div" onclick="playAudio('twr_P_mid')" class="circle" style="top: 270px; left: 165px;">
        <audio id="twr_P_mid" src="{{ url_for('static', filename='audio/twr_P_mid.flac') }}"></audio>
    	</div>
    	<div id="twr_P_top-div" onclick="playAudio('twr_P_top')" class="circle" style="top: 233px; left: 165px;">
        <audio id="twr_P_top" src="{{ url_for('static', filename='audio/twr_P_top.flac') }}"></audio>
    	</div>
    	
    	<div id="twr_O_bot-div" onclick="playAudio('twr_O_bot')" class="circle" style="top: 290px; left: 244px;">
        <audio id="twr_O_bot" src="{{ url_for('static', filename='audio/twr_O_bot.flac') }}"></audio>
    	</div>
    	<div id="twr_O_mid-div" onclick="playAudio('twr_O_mid')" class="circle" style="top: 230px; left: 244px;">
        <audio id="twr_O_mid" src="{{ url_for('static', filename='audio/twr_O_mid.flac') }}"></audio>
    	</div>
    	<div id="twr_O_top-div" onclick="playAudio('twr_O_top')" class="circle" style="top: 157px; left: 244px;">
        <audio id="twr_O_top" src="{{ url_for('static', filename='audio/twr_O_top.flac') }}"></audio>
    	</div>

    	<div id="twr_N_bot-div" onclick="playAudio('twr_N_bot')" class="circle" style="top: 305px; left: 353px;">
        <audio id="twr_N_bot" src="{{ url_for('static', filename='audio/twr_N_bot.flac') }}"></audio>
    	</div>
    	<div id="twr_N_mid-div" onclick="playAudio('twr_N_mid')" class="circle" style="top: 233px; left: 353px;">
        <audio id="twr_N_mid" src="{{ url_for('static', filename='audio/twr_N_mid.flac') }}"></audio>
    	</div>
    	<div id="twr_N_top-div" onclick="playAudio('twr_N_top')" class="circle" style="top: 155px; left: 353px;">
        <audio id="twr_N_top" src="{{ url_for('static', filename='audio/twr_N_top.flac') }}"></audio>
    	</div>
    	
    	<div id="twr_M_bot-div" onclick="playAudio('twr_M_bot')" class="circle" style="top: 307px; left: 415px;">
        <audio id="twr_M_bot" src="{{ url_for('static', filename='audio/twr_M_bot.flac') }}"></audio>
    	</div>
    	<div id="twr_M_mid-div" onclick="playAudio('twr_M_mid')" class="circle" style="top: 245px; left: 415px;">
        <audio id="twr_M_mid" src="{{ url_for('static', filename='audio/twr_M_mid.flac') }}"></audio>
    	</div>
    	<div id="twr_M_top-div" onclick="playAudio('twr_M_top')" class="circle" style="top: 185px; left: 415px;">
        <audio id="twr_M_top" src="{{ url_for('static', filename='audio/twr_M_top.flac') }}"></audio>
    	</div>
    	
    	<div id="twr_K_bot-div" onclick="playAudio('twr_K_bot')" class="circle" style="top: 344px; left: 474px;">
        <audio id="twr_K_bot" src="{{ url_for('static', filename='audio/twr_K_bot.flac') }}"></audio>
    	</div>
    	<div id="twr_K_mid-div" onclick="playAudio('twr_K_mid')" class="circle" style="top: 308px; left: 474px;">
        <audio id="twr_K_mid" src="{{ url_for('static', filename='audio/twr_K_mid.flac') }}"></audio>
    	</div>
    	<div id="twr_K_top-div" onclick="playAudio('twr_K_top')" class="circle" style="top: 236px; left: 474px;">
        <audio id="twr_K_top" src="{{ url_for('static', filename='audio/twr_K_top.flac') }}"></audio>
    	</div>
    	
    	<div id="twr_Q_bot-div" onclick="playAudio('twr_Q_bot')" class="circle" style="top: 270px; left: 562px;">
        <audio id="twr_Q_bot" src="{{ url_for('static', filename='audio/twr_Q_bot.flac') }}"></audio>
    	</div>
    	<div id="twr_Q_mid-div" onclick="playAudio('twr_Q_mid')" class="circle" style="top: 185px; left: 562px;">
        <audio id="twr_Q_mid" src="{{ url_for('static', filename='audio/twr_Q_mid.flac') }}"></audio>
    	</div>
    	<div id="twr_Q_top-div" onclick="playAudio('twr_Q_top')" class="circle" style="top: 90px; left: 562px;">
        <audio id="twr_Q_top" src="{{ url_for('static', filename='audio/twr_Q_top.flac') }}"></audio>
    	</div>
    	
    	<div id="twr_J_bot-div" onclick="playAudio('twr_J_bot')" class="circle" style="top: 325px; left: 628px;">
        <audio id="twr_J_bot" src="{{ url_for('static', filename='audio/twr_J_bot.flac') }}"></audio>
    	</div>
    	<div id="twr_J_mid-div" onclick="playAudio('twr_J_mid')" class="circle" style="top: 283px; left: 628px;">
        <audio id="twr_J_mid" src="{{ url_for('static', filename='audio/twr_J_mid.flac') }}"></audio>
    	</div>
    	<div id="twr_J_top-div" onclick="playAudio('twr_J_top')" class="circle" style="top: 244px; left: 628px;">
        <audio id="twr_J_top" src="{{ url_for('static', filename='audio/twr_J_top.flac') }}"></audio>
    	</div>
    	
    	<div id="twr_I_bot-div" onclick="playAudio('twr_I_bot')" class="circle" style="top: 345px; left: 802px;">
        <audio id="twr_I_bot" src="{{ url_for('static', filename='audio/twr_I_bot.flac') }}"></audio>
    	</div>
    	<div id="twr_I_top-div" onclick="playAudio('twr_I_top')" class="circle" style="top: 310px; left: 802px;">
        <audio id="twr_I_top" src="{{ url_for('static', filename='audio/twr_I_top.flac') }}"></audio>
    	</div>
    	
    	<div id="twr_F_bot-div" onclick="playAudio('twr_F_bot')" class="circle" style="top: 340px; left: 880px;">
        <audio id="twr_F_bot" src="{{ url_for('static', filename='audio/twr_F_bot.flac') }}"></audio>
    	</div>
    	<div id="twr_F_mid-div" onclick="playAudio('twr_F_mid')" class="circle" style="top: 300px; left: 880px;">
        <audio id="twr_F_mid" src="{{ url_for('static', filename='audio/twr_F_mid.flac') }}"></audio>
    	</div>
    	<div id="twr_F_top-div" onclick="playAudio('twr_F_top')" class="circle" style="top: 253px; left: 880px;">
        <audio id="twr_F_top" src="{{ url_for('static', filename='audio/twr_F_top.flac') }}"></audio>
    	</div>
    	
    	<div id="twr_H_bot-div" onclick="playAudio('twr_H_bot')" class="circle" style="top: 360px; left: 908px;">
        <audio id="twr_H_bot" src="{{ url_for('static', filename='audio/twr_H_bot.flac') }}"></audio>
    	</div>
    	
    	<div id="twr_H_top-div" onclick="playAudio('twr_H_top-')" class="circle" style="top: 331px; left: 908px;">
        <audio id="twr_H_top-" src="{{ url_for('static', filename='audio/twr_H_top.flac') }}"></audio>
    	</div>
    	
    	<div id="twr_E_bot-div" onclick="playAudio('twr_E_bot')" class="circle" style="top: 330px; left: 1020px;">
        <audio id="twr_E_bot" src="{{ url_for('static', filename='audio/twr_E_bot.flac') }}"></audio>
    	</div>
    	<div id="twr_E_mid-div" onclick="playAudio('twr_E_mid')" class="circle" style="top: 295px; left: 1020px;">
        <audio id="twr_E_mid" src="{{ url_for('static', filename='audio/twr_E_mid.flac') }}"></audio>
    	</div>
    	<div id="twr_E_top-div" onclick="playAudio('twr_E_top')" class="circle" style="top: 255px; left: 1020px;">
        <audio id="twr_E_top" src="{{ url_for('static', filename='audio/twr_E_top.flac') }}"></audio>
    	</div>
    	
    	<div id="twr_D_bot-div" onclick="playAudio('twr_D_bot')" class="circle" style="top: 352px; left: 1208px;">
        <audio id="twr_D_bot" src="{{ url_for('static', filename='audio/twr_D_bot.flac') }}"></audio>
    	</div>
    	<div id="twr_D_mid-div" onclick="playAudio('twr_D_mid')" class="circle" style="top: 328px; left: 1208px;">
        <audio id="twr_D_mid" src="{{ url_for('static', filename='audio/twr_D_mid.flac') }}"></audio>
    	</div>
    	<div id="twr_D_top-div" onclick="playAudio('twr_D_top')" class="circle" style="top: 304px; left: 1208px;">
        <audio id="twr_D_top" src="{{ url_for('static', filename='audio/twr_D_top.flac') }}"></audio>
    	</div>
    	
    	<div id="twr_C_bot-div" onclick="playAudio('twr_C_bot')" class="circle" style="top: 352px; left: 1311px;">
        <audio id="twr_C_bot" src="{{ url_for('static', filename='audio/twr_C_bot.flac') }}"></audio>
    	</div>
    	<div id="twr_C_mid-div" onclick="playAudio('twr_C_mid')" class="circle" style="top: 328px; left: 1311px;">
        <audio id="twr_C_mid" src="{{ url_for('static', filename='audio/twr_C_mid.flac') }}"></audio>
    	</div>
    	<div id="twr_C_top-div" onclick="playAudio('twr_C_top')" class="circle" style="top: 304px; left: 1311px;">
        <audio id="twr_C_top" src="{{ url_for('static', filename='audio/twr_C_top.flac') }}"></audio>
    	</div>
    	
    </div>
    <div class="header"></div>
    <div class="row-wrapper">
        <div class="row">
            <div class="pane">
                Parameters
                <div class="dropdown-content">
                <p>
                  Click on a circle on one of the towers to play a sound that was recorded on that tower. Click again to stop the file.  Click another circle to switch to another recording.
                  </br></br>
                  Each visitor can trigger only one audio file at a time.
                  </br></br>
                  Audio files are different durations ranging from 16 seconds to 6 minutes, some are monotonous, while other are dynamic and vary over time.
                  </br></br>
                  The audio file will play once through when triggered, and will stop when it reaches the end.
                  </br></br>
                  All visitors hear all sounds that are being triggered and manipulated in real time.
                  </br></br>
                  Each player can manipulate only the sound that they trigger by varying the loudness, speed, and direction of the file.
                  </br></br>
                  Visitors are encouraged to explore the sound library and to collaborate with each other in musical improvisation.  
                </p>
                </div>
            </div>
            <div class="pane">
                Sounds
                <div class="dropdown-content">
                <p>
                  During the two years before the RCI site was demolished in 2014, I made several expeditions to develop a library of recordings by placing contact microphones onto the towers and the wires.  The tall metal structures vibrated in the high marsh winds with a rich and complex variety of tones and drones.
                  </br></br>
                  Each tower on the site was identified by a letter of the alphabet, and I organized the sound library to categorize the recordings by the letter of the tower that they were recorded from. On this website, all sounds were recorded from the actual tower on which their trigger appears. 
                  </br></br>
                  13 towers translate into 13 notes of an approximate chromatic scale. The only processing of these files involved focussing on a key frequency (including sub harmonics and ultra harmonics) for each “note” in the scale, ascending from right to left. In some cases, the perfect pitch frequency for the desired note was not present in the actual recording, so the filter was shifted over to the nearest audible sound, hence resulting in an approximate or pitch-imperfect chromatic scale.
                </p>
                </div>
            </div>
            <div class="pane">
                Context
                <div class="dropdown-content">
                <p>
                  Towering 400 feet above the salt water marsh stood an intricate web of thick wire radio antennas transmitting shortwave all over the world. The horizontal wire antennas were suspended in the air with the support of 13 towers and were connected to the transmitter building via many kilometres of transmission lines.
                  </br></br>
                  Erected in 1938, the Radio Canada International (RCI) shortwave relay site was transmitting by 1942.  RCI broadcast to Europe, Africa, South America, and the Arctic.  In addition to Canadian broadcasts, this site also served as a relay for Radio China, Radio Japan, Radio Korea, Voice of Vietnam, and Vatican Radio. Located in Sackville, New Brunswick, it was perfectly positioned to transmit across the Atlantic Ocean, and covered most of the globe with its transmissions. It was the only high power shortwave relay station in Canada.
                  </br></br>
                  In 2012, RCI shortwave service was terminated.  The last Canadian international shortwave broadcast was sent in June of 2012, the final international relays were sent in October 2012, the last arctic broadcast (and the final broadcast to ever transmit from this site) was sent in November 2012.  
                  
                </p>
                </div>
            </div>
        </div>
        <div class="controls">
        Controls
        </div>
<div class="box-container">
    <div class="slider-row">
        <div class="left-slider">
            Volume</br>
            <div class="control-btn">+</div></br>
            <input onclick="setAudioVolume()" type="range" min="1" max="100" value="50" class="slider" id="volumeSlider" orient="vertical">
            <div class="control-btn">-</div>
        </div>
        <div class="left-slider">
            Speed</br>
            <div class="control-btn">+</div></br>
            <input onclick="setAudioSpeed()" type="range" min="1" max="100" value="50" class="slider" id="speedSlider" orient="vertical">
            <div class="control-btn">-</div>
        </div>
    </div>
  <div class="direction-row">
  <div class="top-section">
    <div class="small-pane">
      <div>Direction</div>
      <div class="horizontal-slider">
        <div onclick="toggleAudioDirection(-1)" class="control-btn"><div class="arrow-left"></div></div>&nbsp;&nbsp;
        <!--<input type="range" min="1" max="100" value="50" class="slider" id="directionSlider">-->
        <div onclick="toggleAudioDirection(1)" class="control-btn"><div class="arrow-right"></div></div>
      </div>
    </div>
    <div class="small-pane">
      <div># of Players</div></br>
      <input type="text" value="X" id="playersCount">
    </div>
    </div>
    
    <!--
    <div class="direction-row">
          <div class="top-section">
    <div class="small-pane">
      Direction
      <input type="range" min="-180" max="180" value="0" class="slider" id="directionSlider">
    </div>
    <div class="small-pane">
      # of Players
      <input type="range" min="1" max="10" value="1" class="slider" id="numPlayersSlider">
    </div>
  </div>
    -->
    <!--
        <div class="map">
	    World Map</br>
	    <img src="https://upload.wikimedia.org/wikipedia/commons/8/80/World_map_-_low_resolution.svg" alt="World Map">
	</div>
    -->
	<div id="chartdiv"></div>

  <script>
    var activeAudio;
    function setCircleColor(id, color){
      var circle_div = document.getElementById(id + "-div");
      circle_div.style.backgroundColor = color;
      console.log("[+] set circle_div id=", circle_div.id, " color=", color);
    }
    function playAudio(id) {
      var audio = document.getElementById(id);
      // another audio playing
      if (activeAudio){
        console.log("[!] got activeAudio id=", activeAudio.id);
        if (!activeAudio.paused && activeAudio.currentTime > 0 && !activeAudio.ended){
          activeAudio.pause();
          console.log("[+] paused active audio sound");
          setCircleColor(activeAudio.id, "#b2a0db");
          socket.emit('broadcast_music', {id: activeAudio.id, volume: activeAudio.volume, speed: activeAudio.speed, state: false});
        }
      }
      // audio being played
      if (audio && !audio.paused && audio.currentTime > 0 && !audio.ended){
        audio.pause();
        setCircleColor(id, "#b2a0db");
        socket.emit('broadcast_music', {id: audio.id, volume: audio.volume, speed: audio.speed, state: false});
      }
      else {
        audio.play();
        setCircleColor(id, "red");
        socket.emit('broadcast_music', {id: audio.id, volume: audio.volume, speed: audio.speed, state: true});
      }
      activeAudio = audio;
    }
    function setAudioVolume(){
      var slider = document.getElementById("volumeSlider");
      console.log("setAudioVolume: value=", slider.value);
      if (activeAudio){
        activeAudio.volume = slider.value / 100;
        console.log("setAudioVolume: volume=", activeAudio.volume);
      }
    }

    var playbackRate = 1;
    var soundDirection = 1;
    function setAudioSpeed()
    {
      var slider = document.getElementById("speedSlider")
      playbackRate = slider.value / 100;
      console.log("setAudioSpeed: sliderValue=", slider.value, " playbackRate=", playbackRate);
      // audio being played
      if (activeAudio && !activeAudio.paused && activeAudio.currentTime > 0 && !activeAudio.ended){
        activeAudio.playbackRate = playbackRate;
      }
    }
    function toggleAudioDirection(direction)
    {
      soundDirection = direction;
      console.log("toggleAudioDirection: playbackRate=", soundDirection);
      // audio being played
      if (activeAudio){
        // FIXME
        // Firefox: Uncaught DOMException: Operation is not supported
        // Chrome: Uncaught DOMException: Failed to set the 'playbackRate' property on 'HTMLMediaElement': The provided playback rate (-1) is not in the supported playback range.
        try {
          activeAudio.playbackRate = playbackRate * soundDirection;
        }
        catch (error) {
            alert("Not Supported in your Browser. Sorry :(");
        }
      }
    }

    // Map

    // Create root
    var root = am5.Root.new("chartdiv"); 

    // Set themes
    root.setThemes([
      am5themes_Animated.new(root)
    ]);


    // Create chart
    var chart = root.container.children.push(am5map.MapChart.new(root, {
      panX: "rotateX",
      panY: "none",
      projection: am5map.geoNaturalEarth1()
    }));



    chart.chartContainer.set("background", am5.Rectangle.new(root, {
      fill: am5.color("#b2a0db"),
      fillOpacity: 0.9
    }));

    // Create polygon series
    var polygonSeries = chart.series.push(am5map.MapPolygonSeries.new(root, {
      geoJSON: am5geodata_worldLow,
      exclude: ["AQ"],
      fill: "black"
    }));

    // Create point series
    var pointSeries = chart.series.push(am5map.MapPointSeries.new(root, {}));

    var data = JSON.parse('{{ users_geoloc | safe }}');

    var users_geoloc = data.geolocations;
    console.log("users_geoloc: ", users_geoloc);
    document.getElementById("playersCount").value = users_geoloc.geolocations.length;

    for (geoloc of users_geoloc.geolocations) {
      console.log(geoloc);
      pointSeries.pushDataItem({ latitude: geoloc[1], longitude: geoloc[0] });
      //console.log('latitude: ', geoloc[0], ', longitude: ', geoloc[1]);
    }

    pointSeries.bullets.push(function() {
      return am5.Bullet.new(root, {
        sprite: am5.Circle.new(root, {
          radius: 5,
          fill: am5.color("#ff0000")
        })
      });
    });

    </script>
  </div>
</div>
<div id="online-users-div" style="visibility: hidden;">
  <h1>Online Users</h1>
  <ul style="color:red;" id="user-list">
  </ul>
</div>
<script>
    
    // Connect to the WebSocket server
    console.log('Connecting to {{ server_uri | safe }} server ...')
    const socket = io.connect('{{ server_uri | safe }}');
    
    socket.on('broadcast_music', function(data) {
      var audio = document.getElementById(data.id);
      if (audio == null){
        console.log("[!] toggle_music id=", audio.id, " [NOT FOUND]");
      }
      console.log("[+] toggle_music id=", audio.id);
      // audio being played
      if (audio && !audio.paused && audio.currentTime > 0 && !audio.ended){
        audio.pause();
        if (data['volume']){
          audio.volume = data['volume'];
        }
        if (data['speed']){
          audio.speed = data['speed'];
        }
        setCircleColor(audio.id, "#b2a0db");
      }
      else {
        audio.play();
        setCircleColor(audio.id, "red");
      }
    });

    // Listen for 'update_users' event
    socket.on('update_users', function(users) {
        // Clear the user list in the DOM
        const userList = document.getElementById("user-list");
        userList.innerHTML = '';

        // Add to the user list in the DOM
        for (const user of users) {
            var li = document.createElement("li");
            li.appendChild(document.createTextNode(user));
            userList.appendChild(li);
        }
    });

    socket.on('update_geolocations', function(geolocations) {
        // Re-Create point series
        pointSeries = chart.series.push(am5map.MapPointSeries.new(root, {}));
        
        console.log("users_geoloc: ", geolocations);
        document.getElementById("playersCount").value = geolocations.length;
        
        for (geoloc of geolocations) {
          console.log(geoloc);
          pointSeries.pushDataItem({ latitude: geoloc[1], longitude: geoloc[0] });
          console.log('latitude: ', geoloc[0], ', longitude: ', geoloc[1]);
        }
        
        pointSeries.bullets.push(function() {
          return am5.Bullet.new(root, {
            sprite: am5.Circle.new(root, {
              radius: 5,
              fill: am5.color("#ff0000")
            })
          });
        });
    });

    // Poll server for user online status every 2 seconds
    setInterval(function() {
        socket.emit('poll');
    }, 5000); // every 5 seconds

    // On window unload, emit a 'disconnect' event
    window.onbeforeunload = function(e) {
        socket.emit('disconnect');
    };
</script>
</body>
</html>
       
